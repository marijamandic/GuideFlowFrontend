<div *ngIf="isUserLoggedIn; else notLoggedIn">
  <div id="profileInfo" class="profile-container">
    <!-- Levi deo: Profilna kartica -->
    <div class="profile-card" *ngIf="profileInfo as pi">
      <hr />
      <div class="profile-header">
        <div class="profile-image-container">
          <!-- Prikaz slike u normalnom režimu -->
          <img 
            [src]="getImagePath(profileInfo.imageUrl)" 
            alt="Profile image" 
            *ngIf="!isEditMode && profileInfo.imageUrl" 
            class="profile-image" 
          />
          <!-- U režimu uređivanja prikaži dugme za odabir slike -->
          <ng-container *ngIf="isEditMode">
            <img 
              *ngIf="imageBase64" 
              [src]="imageBase64" 
              alt="Preview image" 
              class="preview-image" 
            />
            <input 
              type="file" 
              (change)="onFileSelected($event)" 
              class="upload-input"
              id="file-upload"
            />
            <label for="file-upload" class="upload-label">Browse</label>
          </ng-container>
        </div>
      </div>
      <!-- Ostatak levi deo -->
      <div class="profile-row name-row">
        <label>Name:</label>
        <div *ngIf="!isEditMode" class="profile-value">{{ nameSurname }}</div>
        <input *ngIf="isEditMode" type="text" [(ngModel)]="profileInfo.firstName" placeholder="First Name" />
        <input *ngIf="isEditMode" type="text" [(ngModel)]="profileInfo.lastName" placeholder="Last Name" />
      </div>
      <div class="profile-row">
        <label>Moto:</label>
        <div *ngIf="!isEditMode" class="profile-value">{{ pi.moto }}</div>
        <input *ngIf="isEditMode" type="text" [(ngModel)]="profileInfo.moto" placeholder="Your motto" />
      </div>
      <div class="profile-row">
        <label>Biography:</label>
        <div *ngIf="!isEditMode" class="profile-value">{{ pi.biography }}</div>
        <input *ngIf="isEditMode" type="text" [(ngModel)]="profileInfo.biography" placeholder="Your biography" />
      </div>
      <div class="profile-footer">
        <ng-container *ngIf="loggedInUser?.id === userId">
          <button (click)="onEditOrSaveClicked()" class="cta-button small-button">
            {{ isEditMode ? 'Save' : 'Edit' }}
          </button>
        </ng-container>
        <ng-container *ngIf="!viewedUserAuthor && loggedInUser?.id !== userId && loggedInUser?.role !== 'author'">
          <button
            class="cta-button"
            [ngClass]="followedProfiles.includes(userId) ? 'unfollow-button' : 'follow-button'"
            (click)="onFollowButtonClick(userId)"
          >
            {{ followedProfiles.includes(userId) ? 'Unfollow' : 'Follow' }}
          </button>
        </ng-container>
      </div>
    </div>

    <!-- Desni deo: Kartice za level i followere -->
    <ng-container *ngIf="!viewedUserAuthor">
      <div class="right-container">
        <!-- Kartica za level -->
        <div class="level-card">
          <div class="level-header">
            <h3>Tourist Level {{ tourist?.level }}</h3>
            <div class="current-xp">{{ currentXp }} XP</div>
          </div>
          <div class="progress-container">
            <div class="progress-bar" [style.width.%]="progressPercent"></div>
          </div>
          <div class="progress-labels">
            <span>{{ minXp }}</span>
            <span>{{ maxXp }}</span>
          </div>
        </div>
        <!-- Kartica za pratioce -->
        <div class="followers-card">
          <h3>Followers</h3>
          <table>
            <tbody>
              <tr *ngFor="let follower of followers">
                <td>
                  <img [src]="getImagePath(follower.imageUrl)" alt="Follower image" class="follower-image"       [routerLink]="['/profile', follower.followerId]" style="cursor: pointer;" />
                </td>
                <td>    
                  <span 
                    [routerLink]="['/profile', follower.followerId]" 
                    style="cursor: pointer;"
                  >
                    {{ follower.followerUsername }}
                  </span>
                  <td class="action-cell">
                    <ng-container *ngIf="follower.followerId !== loggedInUser?.id; else emptyCell">
                      <button
                        class="cta-button"
                        [ngClass]="followedProfiles.includes(follower.followerId) ? 'unfollow-button' : 'follow-button'"
                        (click)="onFollowButtonClick(follower.followerId)"
                      >
                        {{ followedProfiles.includes(follower.followerId) ? 'Unfollow' : 'Follow' }}
                      </button>
                    </ng-container>
                    <ng-template #emptyCell>
                      <span></span>
                    </ng-template>
                  </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </ng-container>
  </div>
  <!-- Problems Section -->
  <div class="problem-list-card">
    <div class="problem-card-header">
      <h2>Problems</h2>
    </div>
    <div class="problem-card-controls">
      <div class="controls-container">
        <form (ngSubmit)="searchProblems($event)">
          <input type="text" placeholder="Search" class="search-input">
        </form>
        <div class="dropdown-container">
          <select class="sort-dropdown" (change)="sortProblemsByReportDate($event)">
            <option value="latest">Latest</option>
            <option value="oldest">Oldest</option>
          </select>
          <select class="sort-dropdown" (change)="sortProblemsByDeadlineDate($event)">
            <option value="latest">Nearest</option>
            <option value="oldest">Furthest</option>
          </select>
          <select class="sort-dropdown" (change)="filterByStatus($event)">
            <option value="all">All statuses</option>
            <option value="Resolved">Resolved</option>
            <option value="Unresolved">Unresolved</option>
            <option value="Overdue">Overdue</option>
          </select>
        </div>
      </div> 
    </div>
    <table class="problem-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Tourist</th>
          <th>Tour</th>
          <th>Category</th>
          <th>Reported At</th>
          <th>Deadline</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let problem of problems" >
          <td>{{ problem.id }}</td>
          <td>{{ getTouristName(problem.userId) }}</td>
          <td>{{ getTourName(problem.tourId) }}</td>
          <td>{{ getCategoryName(problem.details.category) }}</td>
          <td>{{ problem.resolution.reportedAt | date:'medium' }}</td>
          <td>{{ problem.resolution.deadline | date:'medium' }}</td>
          <td>
            <button class="status-badge" 
                    [ngClass]="{
                      'status-unresolved': getProblemStatus(problem) === 'Unresolved',
                      'status-overdue': getProblemStatus(problem) === 'Overdue',
                      'status-resolved': getProblemStatus(problem) === 'Resolved'
                    }">
              {{ getProblemStatus(problem) }}
            </button>
          </td>       
          <td >
            <button class="action-btn table-btn" (click)="toggleProblemModal(problem)"><i class="fa-solid fa-circle-info"></i></button>
            <button *ngIf="isDeadlineValid(problem.resolution.deadline)" class="action-btn table-btn" (click)="openStatusModal(problem)"><i class="fa fa-wrench"></i></button>
          </td>       
        </tr>        
      </tbody>
    </table>
  </div>
  <!-- Problem Modal -->
  <div class="problem-modal" *ngIf="selectedProblem">
    <div class="problem-modal-content">
      <div class="modal-header">
        <h2>Problem Info</h2>
        <button class="close-btn" (click)="closeProblemModal()">×</button>
      </div>
  
      <!-- Problem Details -->
      <div class="problem-header">
        <div class="username">@{{ opositeUser?.username }}</div>
        <div class="problem-details-table">
          <table>
            <thead>
              <tr>
                <th>Tour Name</th>
                <th>Reported At</th>
                <th>Deadline</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>{{ getTourName(selectedProblem.tourId) }}</td>
                <td>{{ selectedProblem.resolution.reportedAt | date: 'medium' }}</td>
                <td>{{ selectedProblem.resolution.deadline | date: 'medium' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
  
      <!-- Messages Section -->
      <div class="messages-wrapper">
        <div #messagesContainer class="modal-messages">
          <div 
            *ngFor="let message of selectedProblemMessages" class="modal-message"
            [ngClass]="{'modal-message': true, 'me': loggedInUser.id === message.userId, 'other': loggedInUser.id !== message.userId,'description': message.id === 0}">
             {{ message.content }}
            <div class="posted-at">
              {{ message.postedAt | date:'dd/MM/yyyy   HH:mm' }}
            </div>
          </div>
        </div>
        <div class="add-comment">
          <input
            type="text"
            [(ngModel)]="newMessageContent"
            placeholder="Write a message..."
            (keydown.enter)="handleSendMessageClick()"
          />
          <button class="cta-button" (click)="handleSendMessageClick()">Send</button>
        </div>
      </div>
    </div>
  </div>
  <!--Change Status modal-->
  <div class="problem-modal" *ngIf="isStatusModalOpen">
    <div class="problem-modal-content">
      <div class="modal-header">
        <h2>Update Problem Status</h2>
        <button class="close-btn" (click)="closeStatusModal()">×</button>
      </div>
  
      <div class="modal-body">
        <label>
          <input type="radio" name="status" [(ngModel)]="statusUpdate.isResolved" [disabled]="statusProblem?.resolution?.isResolved ?? false" [value]="true" />
          Mark as Resolved
        </label>
        <label>
          <input type="radio" name="status" [(ngModel)]="statusUpdate.isResolved" [disabled]="!statusProblem?.resolution?.isResolved ?? false"[value]="false" />
          Mark as Unresolved
        </label>
        <div class="status-comment">
          <input
            type="text"
            [(ngModel)]="statusUpdate.comment"
            placeholder="Add a comment..."
          />
        </div>
      </div>
  
      <div class="modal-footer">
        <button class="cta-button" (click)="submitStatusUpdate()">Submit</button>
      </div>
    </div>
  </div>
</div>

<ng-template #notLoggedIn>
  <div class="not-logged-in-message">
    You have to log in first...
  </div>
</ng-template>
